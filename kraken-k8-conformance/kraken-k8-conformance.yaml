---
- job-template:
  name: '{name}-k8-conformance'
  project-type: multijob
  parameters:
    - testing-params
  properties:
    - build-discarder:
        days-to-keep: -1
        num-to-keep: 100
        artifact-days-to-keep: -1
        artifact-num-to-keep: -1
    - github:
        url: https://github.com/Samsung-AG/kraken/
    - slack:
        notify-start: true
        notify-success: true
        notify-aborted: true
        notify-failure: true
  scm:
    - git:
        url: ${{KRAKEN_REPO}}
        credentials-id: jenkins-ssh
        branches:
          - ${{KRAKEN_BRANCH}}
        browser: auto
  triggers:
    - github
  wrappers:
    - workspace-cleanup
    - mask-passwords
  builders:
    - multijob:
        name: Build
        condition: SUCCESSFUL
        projects:
          - name: '{name}-build-k8-tests'
            current-parameters: true
            predefined-parameters: 'KUBE_CONFORMANCE_DIR=kubernetes_conformance'
            git-revision: true
          - name: '{name}-build-cluster'
            current-parameters: true
            git-revision: true
    - multijob:
        name: Run
        condition: SUCCESSFUL
        projects:
          - name: '{name}-run-k8s-tests'
            current-parameters: true
            predefined-parameters: 'KUBE_CONFORMANCE_DIR=kubernetes_conformance'
            git-revision: true

  publishers:
    - trigger-parameterized-builds:
      - project: '{name}-upload-conformance-to-s3'
        current-parameters: true
        predefined-parameters: |
          KUBE_CONFORMANCE_DIR=kubernetes_conformance
          KRAKEN_COMMIT=${{GIT_COMMIT}}
        condition: ALWAYS
      - project: '{name}-update-github-pages'
        current-parameters: true
        predefined-parameters: |
          KUBE_CONFORMANCE_DIR=kubernetes_conformance
          TEST_RESULT=Success!
          KRAKEN_COMMIT=${{GIT_COMMIT}}
        condition: SUCCESS
      - project: '{name}-update-github-pages'
        current-parameters: true
        predefined-parameters: |
          KUBE_CONFORMANCE_DIR=kubernetes_conformance
          TEST_RESULT=Failure!
          KRAKEN_COMMIT=${{GIT_COMMIT}}
        condition: FAILED
      - project: '{name}-destroy'
        current-parameters: true
        condition: ALWAYS