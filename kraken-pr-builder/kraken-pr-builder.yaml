---
- job-template:
    name: '{name}-pr-builder'
    project-type: freestyle
    logrotate:
      numToKeep: 100
    parameters:
      - string:
          name: ghprbActualCommit
          description: "Commit Id"
      - string:
          name: KRAKEN_CLUSTER_NAME
          default: kraken_pr_builder-${{BUILD_NUMBER}}
          description: "Used by kraken to name a few cluster resources: AWS resources, context name, DNS records, etc."
      - string:
          name: KUBE_BINARIES_URI
          default: "https://storage.googleapis.com/kubernetes-release/release/v1.1.7/bin/linux/amd64"
          description: "Link to kubernetes binaries"
    properties:
      - github:
          url: https://github.com/Samsung-AG/kraken/
      - slack:
          notify-start: true
          notify-success: true
          notify-aborted: true
          notify-failure: true
    scm:
      - git:
          url: git@github.com:Samsung-AG/kraken.git
          credentials-id: jenkins-ssh
          branches:
            - ${{ghprbActualCommit}}
          browser: auto
          wipe-workspace: false
          skip-tag: true
    triggers:
      - github-pull-request:
          admin-list: '{obj:ci_admin_list}'
          github-hooks: true
    wrappers:
      - workspace-cleanup
      - mask-passwords
    builders:
      - shell:
         !include-raw-escape: include-raw001-kraken-build.sh
    publishers:
      - junit:
          results: output/cucumber/junit/*
          health-scale-factor: 1.0
      - trigger-parameterized-builds:
        - project: '{name}-destroy'
          current-parameters: true
          predefined-parameters: |
            KRAKEN_CLUSTER_NAME=kraken_pr_builder-${{BUILD_NUMBER}}
          condition: ALWAYS
      - slack:
          team-domain: '{slack_domain}'
          auth-token: '{slack_api_token}'
          room: '{slack_room}'
          build-server-url: 'https://{ci_hostname}'


