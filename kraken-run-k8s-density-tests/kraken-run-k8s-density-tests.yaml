---
- job-template:
    name: '{name}-run-k8s-density-tests'
    project-type: freestyle
    logrotate:
      numToKeep: 100
    parameters:
      - clustername-params
      - density-params
      - string:
          name: DENSITY
          description: "which pod density to use"
    properties:
      - github:
          url: https://github.com/Samsung-AG/kraken/
      - slack:
          notify-start: true
          notify-success: true
          notify-aborted: true
          notify-failure: true
      - copyartifact:
          projects: kraken*
    scm:
      - git:
          url: ${{KRAKEN_REPO}}
          credentials-id: jenkins-ssh
          branches:
            - ${{KRAKEN_BRANCH}}
          browser: auto
          wipe-workspace: false
          skip-tag: true
    wrappers:
      - workspace-cleanup
      - mask-passwords
    builders:
      - shell: 
          !include-raw-escape: include-raw001-kraken-run-k8s-density-tests.sh
    publishers:
      - trigger-parameterized-builds:
        - project: '{name}-upload-to-s3'
          current-parameters: true
          predefined-parameters: |
            TEST_KIND=conformance
            PROJECT_NAME=${{JOB_NAME}}
            PROJECT_BUILD=${{BUILD_NUMBER}}
            PROJECT_ARTIFACT=kraken_${{GIT_COMMIT}}.log
          condition: ALWAYS
        - project: '{name}-update-github-pages'
          current-parameters: true
          predefined-parameters: |
            KRAKEN_COMMIT=${{BUILD_TAG}}
            TEST_RESULT=Success!
            TEST_KIND=density
            LOG_LINK='http://s3-us-west-2.amazonaws.com/{test_bucket}/density/${{BUILD_TAG}}-${{DENSITY}}.log'
          condition: SUCCESS
        - project: '{name}-update-github-pages'
          current-parameters: true
          predefined-parameters: |
            KRAKEN_COMMIT=${{BUILD_TAG}}
            TEST_RESULT=Failure!
            TEST_KIND=density
            LOG_LINK='http://s3-us-west-2.amazonaws.com/{test_bucket}/density/${{BUILD_TAG}}-${{DENSITY}}.log'
          condition: FAILED
      - junit:
          results: output/**/junit*.xml
          health-scale-factor: 1.0
      - slack:
          team-domain: '{slack_domain}'
          auth-token: '{slack_api_token}'
          room: '{slack_room}'
          build-server-url: 'https://{ci_hostname}'
