---
- job-template:
    name: '{name}-k8s-conformance'
    description: '[deprecated] build a kraken cluster, run kubernetes conformance tests against it, destroy the kraken cluster'
    concurrent: true
    project-type: multijob
    logrotate:
      numToKeep: 100
    parameters:
      - kraken-fetch-kubernetes-params
      - default-kraken-params
    properties:
      - github:
          url: https://github.com/samsung-cnct/kraken/
    scm:
      - git:
          url: ${{KRAKEN_REPO}}
          credentials-id: jenkins-ssh
          branches:
            - ${{KRAKEN_BRANCH}}
          browser: auto
          wipe-workspace: false
          skip-tag: true
    builders:
      - inject:
          properties-content: |
            KRAKEN_CLUSTER_NAME=kubernetes_conformance-${{BUILD_NUMBER}}
            KUBE_TESTS_DIR=kubernetes_conformance-${{BUILD_NUMBER}}
      - kraken-fetch-kubernetes-builder:
          kubernetes_release_version: '${{KUBERNETES_RELEASE_VERSION}}'
          kube_tests_dir: '${{KUBE_TESTS_DIR}}'
      - kraken-build-cluster-builder
      - trigger-builds:
        - project: 'kraken-run-k8s-conformance-tests'
          predefined-parameters: |
            KRAKEN_CLUSTER_NAME=${{KRAKEN_CLUSTER_NAME}}
            KRAKEN_REPO=${{KRAKEN_REPO}}
            KRAKEN_BRANCH=${{KRAKEN_BRANCH}}
            KUBE_TESTS_DIR=${{KUBE_TESTS_DIR}}
          git-revision: true
          block: true
    publishers:
      - postbuildscript:
          builders:
            - kraken-clean-kubernetes-builder:
                kube_tests_dir: '${{KUBE_TESTS_DIR}}'
            - kraken-destroy-cluster-builder
          script-only-if-succeeded: False
          script-only-if-failed: False
      - slack-publisher
