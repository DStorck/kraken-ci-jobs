---
- job-template:
    name: '{name}-k8s-conformance'
    description: 'Do not edit this job through the web! Runs all the jobs required to run a parameterized set of kubernetes conformance tests'
    concurrent: true
    project-type: multijob
    logrotate:
      numToKeep: 100
    parameters:
      - kraken-fetch-kubernetes-params
      - default-kraken-params
    properties:
      - github:
          url: https://github.com/samsung-cnct/kraken/
    scm:
      - git:
          url: ${{KRAKEN_REPO}}
          credentials-id: jenkins-ssh
          branches:
            - ${{KRAKEN_BRANCH}}
          browser: auto
          wipe-workspace: false
          skip-tag: true
    builders:
      - inject:
          properties-content: |
            KRAKEN_CLUSTER_NAME=kubernetes_conformance-${{BUILD_NUMBER}}
            KUBE_TESTS_DIR=kubernetes_conformance-${{BUILD_NUMBER}}
      - multijob:
          name: Build
          condition: SUCCESSFUL
          projects:
            - name: '{name}-fetch-kubernetes'
              predefined-parameters: |
                KUBE_TESTS_DIR=${{KUBE_TESTS_DIR}}
                KUBERNETES_RELEASE_VERSION=${{KUBERNETES_RELEASE_VERSION}}
            - name: '{name}-build-cluster'
              # NB: only passing KRAKEN_CLUSTER_NAME explicitly since it's not
              #     defined as a parameter of this job; the rest we're passing
              #     implicitly since the majority of them are needed
              predefined-parameters: |
                KRAKEN_CLUSTER_NAME=${{KRAKEN_CLUSTER_NAME}}
              current-parameters: true
              git-revision: true
      - multijob:
          name: Run
          condition: SUCCESSFUL
          projects:
            - name: '{name}-run-k8s-conformance-tests'
              predefined-parameters: |
                KRAKEN_CLUSTER_NAME=${{KRAKEN_CLUSTER_NAME}}
                KRAKEN_REPO=${{KRAKEN_REPO}}
                KRAKEN_BRANCH=${{KRAKEN_BRANCH}}
                KUBE_TESTS_DIR=${{KUBE_TESTS_DIR}}
              git-revision: true
    publishers:
      - trigger-parameterized-builds:
        - project: '{name}-destroy-cluster'
          predefined-parameters: |
            KRAKEN_CLUSTER_NAME=${{KRAKEN_CLUSTER_NAME}}
            KRAKEN_REPO=${{KRAKEN_REPO}}
            KRAKEN_BRANCH=${{KRAKEN_BRANCH}}
            TOTAL_WAIT=${{TOTAL_WAIT}}
            TERRAFORM_APPLY_RETRIES=${{TERRAFORM_APPLY_RETRIES}}
            TERRAFORM_DESTROY_RETRIES=${{TERRAFORM_DESTROY_RETRIES}}
          condition: ALWAYS
        - project: '{name}-clean-kubernetes'
          predefined-parameters: |
            KUBE_TESTS_DIR=${{KUBE_TESTS_DIR}}
          condition: ALWAYS
      - slack-publisher
